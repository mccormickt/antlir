# @oss-disable
load("//antlir/antlir2/bzl/feature:defs.bzl", "feature")
load("//antlir/antlir2/bzl/image:defs.bzl", "image")
load("//antlir/antlir2/bzl/package:docker_archive.bzl", "docker_archive")
load("//antlir/antlir2/testing:image_test.bzl", "image_python_test")
load("//antlir/bzl:build_defs.bzl", "rust_binary")

oncall("antlir")

rust_binary(
    name = "make-oci-layer",
    srcs = ["src/main.rs"],
    visibility = ["PUBLIC"],
    deps = [
        "anyhow",
        "clap",
        "nix",
        "tar",
        "//antlir/antlir2/antlir2_change_stream:antlir2_change_stream",
        "//antlir/antlir2/antlir2_rootless:antlir2_rootless",
    ],
)

# Test file permissions preservation in OCI layer tars.
# When files have metadata-only changes (e.g., xattr modifications) without
# content changes, their filesystem permissions must be preserved in the
# generated OCI layer tar archive.

image.layer(
    name = "parent-layer-with-permissions",
    features = [
        feature.rpms_install(rpms = [
            "attr",
            "bash",
            "coreutils",
        ]),
        # Create files with specific permissions
        feature.install_text(
            dst = "/test_file.sh",
            mode = 0o755,
            text = "#!/bin/bash\necho test\n",
        ),
        feature.install_text(
            dst = "/readonly.txt",
            mode = 0o444,
            text = "readonly content\n",
        ),
        feature.install_text(
            dst = "/private.txt",
            mode = 0o600,
            text = "private content\n",
        ),
    ],
)

image.layer(
    name = "child-layer-with-metadata-change",
    features = [
        # Add xattr to files (metadata-only change)
        # This simulates the scenario where permissions from the filesystem
        # need to be preserved when only metadata changes
        feature.genrule(
            bash = """
                setfattr -n user.test -v test_value /test_file.sh
                setfattr -n user.test -v test_value /readonly.txt
                setfattr -n user.test -v test_value /private.txt
            """,
            user = "root",
        ),
    ],
    parent_layer = ":parent-layer-with-permissions",
)

docker_archive(
    name = "file-permissions-docker-archive",
    entrypoint = [],
    layer = ":child-layer-with-metadata-change",
)

image.layer(
    name = "test-layer",
    features = [
        feature.rpms_install(rpms = [
            "podman",
            "python3",
        ]),
    ],
)

image_python_test(
    name = "test-file-permissions",
    srcs = ["tests/test_file_permissions.py"],
    env = {
        "DOCKER_ARCHIVE": "$(location :file-permissions-docker-archive)",
    },
    exec_compatible_with = select({
        "ovr_config//cpu:arm64": ["ovr_config//cpu:arm64"],
        "ovr_config//cpu:x86_64": ["ovr_config//cpu:x86_64"],
    }),
    # @oss-disable
    layer = ":test-layer",
)

# Test file permissions preservation for files with content changes.
# This tests the Contents::File code path where file content is modified,
# not just metadata. This complements the metadata-only tests above.

image.layer(
    name = "parent-layer-with-content",
    features = [
        feature.rpms_install(rpms = [
            "bash",
            "coreutils",
        ]),
        # Create files with specific permissions that will have content changes
        feature.install_text(
            dst = "/executable.sh",
            mode = 0o755,
            text = "#!/bin/bash\necho original\n",
        ),
        feature.install_text(
            dst = "/config.conf",
            mode = 0o644,
            text = "setting=original\n",
        ),
        feature.install_text(
            dst = "/secret.key",
            mode = 0o600,
            text = "original-secret\n",
        ),
    ],
)

image.layer(
    name = "child-layer-with-content-change",
    features = [
        # Modify file content (not just metadata) to trigger Contents::File path
        feature.genrule(
            bash = """
                echo '#!/bin/bash' > /executable.sh
                echo 'echo modified' >> /executable.sh
                chmod 755 /executable.sh
                echo 'setting=modified' > /config.conf
                chmod 644 /config.conf
                echo 'modified-secret' > /secret.key
                chmod 600 /secret.key
            """,
            user = "root",
        ),
    ],
    parent_layer = ":parent-layer-with-content",
)

docker_archive(
    name = "file-permissions-content-change-docker-archive",
    entrypoint = [],
    layer = ":child-layer-with-content-change",
)

image_python_test(
    name = "test-file-permissions-content-change",
    srcs = ["tests/test_file_permissions_content_change.py"],
    env = {
        "DOCKER_ARCHIVE": "$(location :file-permissions-content-change-docker-archive)",
    },
    exec_compatible_with = select({
        "ovr_config//cpu:arm64": ["ovr_config//cpu:arm64"],
        "ovr_config//cpu:x86_64": ["ovr_config//cpu:x86_64"],
    }),
    # @oss-disable
    layer = ":test-layer",
)

# Test directory metadata changes handling in OCI layers.
# When directories have metadata-only changes (chown, chmod, set_times, xattrs),
# the change stream must emit proper Close operations. Without Close operations,
# make_oci_layer fails with "not all entries were closed" error.
# This test ensures directories with metadata changes are properly handled.

image.layer(
    name = "parent-layer-with-directories",
    features = [
        feature.rpms_install(rpms = [
            "attr",
            "bash",
            "coreutils",
        ]),
        # Create directories with initial permissions and ownership
        feature.ensure_dirs_exist(dirs = "/var/cache/testdir"),
        feature.ensure_dirs_exist(dirs = "/var/lib/testdata"),
        feature.ensure_dirs_exist(dirs = "/opt/app"),
    ],
)

image.layer(
    name = "child-layer-with-directory-metadata-changes",
    features = [
        # Modify directory metadata (not file metadata) - this is the critical difference
        # from the file permission tests. This exercises the directory Close operation
        # code path to ensure directories with metadata changes are properly handled.
        feature.genrule(
            bash = """
                # Change directory permissions (chmod on directory)
                chmod 700 /var/cache/testdir

                # Change directory ownership (chown on directory)
                # Using numeric IDs to avoid dependency on user existence
                chown 1000:1000 /var/lib/testdata

                # Add xattr to directory (xattr on directory)
                setfattr -n user.app -v production /opt/app
            """,
            user = "root",
        ),
    ],
    parent_layer = ":parent-layer-with-directories",
)

docker_archive(
    name = "directory-metadata-changes-docker-archive",
    entrypoint = [],
    layer = ":child-layer-with-directory-metadata-changes",
)

image_python_test(
    name = "test-directory-metadata-changes",
    srcs = ["tests/test_directory_metadata_changes.py"],
    env = {
        "DOCKER_ARCHIVE": "$(location :directory-metadata-changes-docker-archive)",
    },
    exec_compatible_with = select({
        "ovr_config//cpu:arm64": ["ovr_config//cpu:arm64"],
        "ovr_config//cpu:x86_64": ["ovr_config//cpu:x86_64"],
    }),
    # @oss-disable
    layer = ":test-layer",
)
